{"dependencies":[{"name":"/home/akiohayakawa/workspace/browser_editor/package.json","includedInParent":true,"mtime":1532065308636},{"name":"./../EditorUtils","loc":{"line":1,"column":24}},{"name":"./SDNConnector","loc":{"line":2,"column":22}},{"name":"./editor","loc":{"line":3,"column":19}},{"name":"./../currentGraph","loc":{"line":4,"column":18}},{"name":"./../misc/Definitions","loc":{"line":5,"column":24}},{"name":"./SDNLink","loc":{"line":6,"column":17}},{"name":"./SDNSvgArea","loc":{"line":7,"column":20}}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0});var t=require(\"./../EditorUtils\"),e=h(t),n=require(\"./SDNConnector\"),r=h(n),i=require(\"./editor\"),o=h(i),a=require(\"./../currentGraph\"),s=h(a),u=require(\"./../misc/Definitions\"),l=h(u),c=require(\"./SDNLink\"),f=h(c),p=require(\"./SDNSvgArea\"),d=h(p);function h(t){return t&&t.__esModule?t:{default:t}}var y=function t(n,i){var a,u=this,c=n.type,p=e.default.getComponent(c),d=s.default.layers(),h=t.calcDefaultUniqueName(n.name||null,c,d),y=n.x||0,m=n.y||0,_=p.property,E=function(){var t={};return _.forEach(function(e){return t[e.name]=e.value}),t};this._allProperties=E,this._grabbedPoint=null,this._startTouchPoint=null,this._startPosition=null,this._component=p,this._background=i,this._properties=E(),this._userInputProperties=n.properties||(a={},_.forEach(function(t){t.editable&&(a[t.name]=t.value)}),a),delete this._userInputProperties.Name;var T=this,O=p.color.substring(2,8),C=s.default.selection,I=function(t){},R={canConnect:function(){return!1}},A=i.layerGroup().node(),g=d3.behavior.drag().on(\"dragstart\",function(){var e=d3.mouse(A),n=function(e){var n=C.layer.focused(),r=C.layer.apply(function(t){return t.serialize()});if(n!==T){var o=(n||{getOutConnector:function(){return null}}).getOutConnector()||R,a=T.getInConnector()||R;o.canConnect()&&a.canConnect()&&!o.connectedWith(a)&&(I=function(e){if(e()){var i=o.linkTo(a).serialize(),u=n.serialize(),l=T.serialize();window.nnc.components.Editor.history.execute({type:\"push\",argument:{name:function(){return\"Edit link\"},undo:function(){f.default.findObjectBySerialized(i).remove(),s.default.selection.layer.remove(t.findObjectBySerialized(l)),r.map(t.findObjectBySerialized).filter(function(t){return t}).forEach(function(t){return s.default.selection.layer.insert(t)}),s.default.selection.layer.focus(t.findObjectBySerialized(u))},exec:function(){s.default.selection.layer.focus(t.findObjectBySerialized(l)),f.default.deserialize(i)}}})}})}var u=C.layer.members().some(function(t){return t===T}),l=d3.event.sourceEvent.ctrlKey;u&&l?s.default.selection.layer.remove(T):(u||l&&!C.link.focused()||s.default.selection.clear(),s.default.selection.layer.insert(T),s.default.selection.layer.focus(T));var c=C.layer.apply(function(t){var e=t.getPosition();return{target:t,position:e,frame:i.createLayerDestinationFrame(e)}}),p=c.map(function(t){return t.target});return{move:function(t){i.showGrid(),c.forEach(function(n){var r=n.target;r.setPosition({x:n.position.x+t.x-e.x,y:n.position.y+t.y-e.y}),n.frame.move(i.calcLayerDropPosition(r,p))}),i.trackCursorMovement(t)},destroy:function(){I(function(){return d3.event.sourceEvent.shiftKey}),I=function(t){};var t=c.map(function(t){return{name:t.target.name(),from:t.position,to:t.frame.getPosition()}});t.some(function(t){return t.to.x!==t.from.x||t.to.y!==t.from.y})?window.nnc.components.Editor.history.execute({type:\"push-and-execute\",argument:{exec:function(){var e=s.default.layers(),n=t.map(function(t){return{target:e.find(function(e){return e.name()==t.name}),recipe:t}}).filter(function(t){return!!t.target});n.forEach(function(t){t.target.setPosition(t.recipe.to),t.recipe.links=t.target.autoLink()}),i.requestAdjustSize(n.map(function(t){return t.target}))},undo:function(){var e=s.default.layers(),n=t.concat().reverse().map(function(t){return{target:e.find(function(e){return e.name()==t.name}),recipe:t}}).filter(function(t){return!!t.target});n.forEach(function(t){t.recipe.links.undo(),delete t.recipe.links,t.target.setPosition(t.recipe.from)}),i.requestAdjustSize(n.map(function(t){return t.target}))},name:function(){return\"Drag Layer\"}}}):(c.forEach(function(t){return t.target.setPosition(t.position)}),i.requestAdjustSize(p)),c.forEach(function(t){t.frame.destroy()}),i.hideGrid()}}}({x:e[0],y:e[1]});i.setDragContext(n)}),L=l.default.EDIT.LAYER;this._selectFrame=i.focusGroup().append(\"rect\").attr(\"x\",y).attr(\"y\",m).attr(\"width\",L.FRAME.WIDTH).attr(\"height\",L.FRAME.HEIGHT).attr(\"pointer-events\",\"none\").style(\"fill\",L.FRAME.FILL_COLOR).style(\"stroke\",L.FRAME.DEFAULT.STROKE_COLOR).style(\"stroke-width\",L.FRAME.STROKE_WIDTH).style(\"filter\",L.FRAME.DEFAULT.FILTER_URL),this._group=i.layerGroup().append(\"g\").attr(\"class\",\"layer-component\"),this._mainImage=this._group.append(\"rect\").attr(\"width\",L.RECT_WIDTH).attr(\"height\",L.RECT_HEIGHT).style(\"fill\",\"#\"+O).style(\"stroke\",\"#\"+O).on(\"mouseenter\",function(){o.default.stockLayer(T)}).on(\"mouseleave\",function(){o.default.stockLayer(null)}).call(g),this._warnImage=this._group.append(\"image\").attr(\"xlink:href\",L.WARN.IMAGE_SOURCE).attr(\"x\",L.WARN.OFFSET_X).attr(\"y\",L.WARN.OFFSET_Y).attr(\"width\",L.WARN.WIDTH).attr(\"height\",L.WARN.HEIGHT).style(\"display\",\"none\");var v=l.default.EDIT.CONNECTOR.ACCEPTS,S=t._sideConnectorPosition(p.inputSideConnector.length);this._sideConnector=p.inputSideConnector.map(function(t){return new r.default(T,u._group,b,P,l.default.EDIT.CONNECTOR.IN,v.SINGLE,t.name,t.shortName||t.name.substring(0,1),L.CONNECTOR.SIDE.FILL_COLOR,S.next())});var F=this._group.append(\"g\").attr(\"clip-path\",\"url(#\"+L.CLIP_PATH.ID+\")\").attr(\"transform\",\"translate(\"+L.CLIP_PATH.OFFSET_X+\",\"+l.default.EDIT.LAYER.CLIP_PATH.OFFSET_Y+\")\");this._label=F.append(\"text\").attr(\"x\",L.NAME_LABEL.OFFSET_X).attr(\"y\",L.NAME_LABEL.OFFSET_Y).attr(\"pointer-events\",\"none\").attr(\"fill\",L.NAME_LABEL.FONTCOLOR).attr(\"font-size\",L.NAME_LABEL.FONTSIZE).text(h),this._labelFirst=this._group.append(\"text\").attr(\"x\",L.DROPCAP_CHAR.OFFSET_X).attr(\"y\",L.DROPCAP_CHAR.OFFSET_Y).attr(\"fill\",L.DROPCAP_CHAR.FONTCOLOR).attr(\"font-size\",L.DROPCAP_CHAR.FONTSIZE).attr(\"pointer-events\",\"none\").style(\"text-anchor\",L.DROPCAP_CHAR.TEXT_ANCHOR).text(c.substring(0,1));var N=function(t){switch(t){case 0:return v.NONE;case 1:return v.SINGLE;default:case-1:return v.MULTIPLE}},P={set:function(t){return i.setDragContext(t)}},b=i.linkGroup();p.input&&(this._inConnector=new r.default(this,this._group,b,P,l.default.EDIT.CONNECTOR.IN,N(p.input),\"\",\"\",L.CONNECTOR.STROKE_COLOR,{x:L.CONNECTOR.OFFSET_X,y:0})),p.output&&(this._outConnector=new r.default(this,this._group,b,P,l.default.EDIT.CONNECTOR.OUT,N(p.output),\"\",\"\",L.CONNECTOR.STROKE_COLOR,{x:L.CONNECTOR.OFFSET_X,y:L.CONNECTOR.OUTPIN_OFFSET_Y})),this._importantPropertyLabel=null,this._statisticsLabel=null,this._statisticsBar=null;var x=void 0;switch(this.type()){default:x=F.append(\"text\").attr(\"x\",L.PROPERTY_LABEL.OFFSET_X).attr(\"y\",L.PROPERTY_LABEL.OFFSET_Y).attr(\"opacity\",L.PROPERTY_LABEL.OPACITY).attr(\"pointer-events\",\"none\").style(\"fill\",L.PROPERTY_LABEL.FONTCOLOR).style(\"font-size\",L.PROPERTY_LABEL.FONTSIZE).style(\"font-weight\",L.PROPERTY_LABEL.FONTWEIGHT),this.displayComment=function(){},this.displayImportantProperty=function(){x.text(p.property.filter(function(t){return t.important}).map(function(t){var e=t.name;return(t.shortName||e)+\" : \"+u._properties[e]}).join(\", \"))},this._importantPropertyLabel=x,this.displayImportantProperty();break;case\"Comment\":x=this._group.append(\"foreignObject\").attr(\"width\",L.RECT_WIDTH).attr(\"height\",L.RECT_HEIGHT).append(\"xhtml:div\").style(\"font-size\",L.COMMENT.FONT_SIZE).style(\"width\",\"100%\").style(\"height\",\"100%\").style(\"word-wrap\",\"break-word\").style(\"overflow\",\"hidden\").style(\"cursor\",\"default\").call(g),this.displayComment=function(){return x.text(u._userInputProperties.Comment||\"\")},this.displayImportantProperty=function(){},this._mainImage.transition().style(\"fill\",L.COMMENT.FILL_COLOR),this._label.transition().style(\"display\",\"none\"),this._labelFirst.transition().style(\"display\",\"none\"),this._importantPropertyLabel=x,this.displayComment()}this._statisticsBar=this._group.append(\"rect\").attr(\"x\",L.STATISTICS.BAR.OFFSET_X).attr(\"y\",L.STATISTICS.BAR.OFFSET_Y).attr(\"width\",L.STATISTICS.BAR.WIDTH).attr(\"height\",L.STATISTICS.BAR.HEIGHT).attr(\"pointer-events\",\"none\").style(\"fill\",L.STATISTICS.BAR.FILL_COLOR),this._statisticsLabel=this._group.append(\"text\").attr(\"x\",L.STATISTICS.LABEL.OFFSET_X).attr(\"y\",L.STATISTICS.LABEL.OFFSET_Y).attr(\"fill\",L.STATISTICS.LABEL.FONTCOLOR).attr(\"font-size\",L.STATISTICS.LABEL.FONTSIZE).attr(\"pointer-events\",\"none\").text(\"\"),this._group.style(\"display\",null),this.setPosition({x:y,y:m}),s.default.insertLayer(this)};y._sideConnectorPosition=function(){var t=l.default.EDIT.LAYER.CONNECTOR.SIDE.MARGIN_X,e=l.default.EDIT.LAYER.CONNECTOR.SIDE.MARGIN_Y,n=l.default.EDIT.LAYER.CONNECTOR.SIDE.START_OFFSET_X,r=l.default.EDIT.LAYER.CONNECTOR.SIDE.START_OFFSET_Y,i=Math.max.apply(null,nNablaCore.layers.components.map(function(t){return t.inputSideConnector.length})),o=function(){var e=n,r=e-t;return function(){var t;return(t=[r,e],e=t[0],r=t[1],t)[1]}}(),a=function(){var t=r,n=t-e;return function(){var e;return(e=[n,t],t=e[0],n=e[1],e)[1]}}(),s=Array(i).fill(null).map(function(t){return{x:o(),y:a()}});return function(t){var e,n=s.slice(0,t).reverse();return{next:(e=0,function(){return n[e++]})}}}(),y.prototype.getInConnector=function(t){return t?this._sideConnector.find(function(e){return e.name()===t}):this._inConnector},y.prototype.getOutConnector=function(t){return t?null:this._outConnector},function(){var t=function(t){return t};y.prototype.getInConnectors=function(){return this._sideConnector.concat(this._inConnector).filter(t)},y.prototype.allLinks=function(){return this._sideConnector.concat(this._inConnector,this._outConnector).filter(t).map(function(t){return t.links()}).reduce(function(t,e){return t.concat(e)},[])}}(),y.prototype.name=function(t){var e=this._label.text();return t&&this._label.text(t),e},y.prototype.getPosition=function(){var t=(this._group.attr(\"transform\")||\"translate(0, 0)\").match(/translate\\((.+),(.+)\\)/);return t?{x:parseInt(t[1]),y:parseInt(t[2])}:{x:0,y:0}},y.prototype.setPosition=function(t){var e=t.x,n=t.y;this._group.attr(\"transform\",\"translate(\"+e+\",\"+n+\")\"),this._selectFrame.attr(\"x\",e).attr(\"y\",n),s.default.setDirtyLinksOf(this)},y.prototype.frameSize=function(){var t={width:l.default.EDIT.LAYER.FRAME.WIDTH,height:l.default.EDIT.LAYER.FRAME.HEIGHT};return function(){return t}}(),y.prototype.type=function(){return this._component.name},y.prototype.component=function(){return this._component},y.prototype.setProperties=function(t){Object.assign(this._properties,t)},y.prototype.getProperty=function(t){return this._properties[t]},y.prototype.getUserInputProperty=function(t){return\"Name\"===t?this.name():this._userInputProperties[t]},y.prototype.setUserInputProperty=function(t,e){switch(t){case\"Name\":this.calcAndSetUniqueName(e);break;default:this._userInputProperties[t]=e,this.displayComment(),window.nnc.components.Editor.onChangedProperty(this.name(),t,e)}},function(){var t=l.default.EDIT.LAYER.FRAME.DEFAULT.STROKE_COLOR,e=l.default.EDIT.LAYER.FRAME.FOCUSED.STROKE_COLOR,n=l.default.EDIT.LAYER.FRAME.DEFAULT.FILTER_URL,r=l.default.EDIT.LAYER.FRAME.FOCUSED.FILTER_URL;y.prototype.select=function(n){this._selectFrame.style(\"stroke\",n?e:t),window.nnc.components.Editor.onChangedSelection(s.default.selection.layer)},y.prototype.flagAsMain=function(t){this._selectFrame.style(\"filter\",t?r:n),window.nnc.components.Editor.onChangedSelection(s.default.selection.layer)},y.prototype.selected=function(){return this._selectFrame.style(\"stroke\")===e}}(),y.prototype.remove=function(){window.nnc.components.Editor.onDeletedLayer(this.name()),d.default.hideAndRemove(this._mainImage),d.default.hideAndRemove(this._warnImage),d.default.hideAndRemove(this._selectFrame),d.default.hideAndRemove(this._label),d.default.hideAndRemove(this._labelFirst),[].concat(this._inConnector,this._outConnector,this._sideConnector).filter(function(t){return t}).forEach(function(t){return t.remove()}),d.default.hideAndRemove(this._importantPropertyLabel),d.default.hideAndRemove(this._statisticsLabel),d.default.hideAndRemove(this._statisticsBar),d.default.hideAndRemove(this._group),s.default.removeLayer(this),delete this._grabbedPoint,delete this._startTouchPoint,delete this._startPosition,delete this._selected,delete this._group,delete this._mainImage,delete this._warnImage,delete this._selectFrame,delete this._label,delete this._labelFirst,delete this._inConnector,delete this._sideConnector,delete this._outConnector,delete this._importantPropertyLabel,delete this._statisticsLabel,delete this._statisticsBar,delete this._gridPosition},y.prototype.autoLink=function(){var t=l.default.EDIT.LAYER.RECT_HEIGHT,e={getInConnector:function(){return null},getOutConnector:function(){return null}},n=function(t){var e=t.links();if(1===e.length&&1===t.linkingLimit()){var n=e[0],r=n.serialize();return n.remove(),{destroy:function(){return f.default.findObjectBySerialized(r).remove()},repair:function(){return f.default.deserialize(r)}}}return{destroy:function(){},repair:function(){}}};return function(){var r=void 0,i=void 0,o=void 0,a=void 0,u=this.getPosition(),l=new Array(4),c=s.default.layers();if(a=this.getInConnector()){!(o=(c.find(function(e){var n=e.getPosition();return n.x===u.x&&n.y+t===u.y})||e).getOutConnector())||o.links().find(function(t){return t.destination()===a})?r=null:(l[0]=n(a),l[1]=n(o),r=o.linkTo(a).serialize())}if(a=this.getOutConnector()){!(o=(c.find(function(e){var n=e.getPosition();return n.x===u.x&&n.y-t===u.y})||e).getInConnector())||o.links().find(function(t){return t.source()===a})?i=null:(l[2]=n(a),l[3]=n(o),i=a.linkTo(o).serialize())}return{redo:function(){l.forEach(function(t){return t.destroy()}),r&&f.default.deserialize(r),i&&f.default.deserialize(i)},undo:function(){r&&f.default.findObjectBySerialized(r).remove(),i&&f.default.findObjectBySerialized(i).remove(),l.forEach(function(t){return t.repair()})}}}}(),y.prototype.setErrorProperties=function(t){var e=void 0;t&&t.length?(e=null,this._errorProperties=t):(e=\"none\",delete this._errorProperties),this._warnImage.style(\"display\",e)},y.prototype.changePropertyValue=function(t,e){\"Name\"===t?this.calcAndSetUniqueName(y.stripForbiddenCharactersForName(e)):t&&t in this._properties&&(this._userInputProperties[t]=e)},y.prototype.serialize=function(){var t=this.getPosition(),e=Object.assign({},this._userInputProperties);return delete e.Name,{name:this.name(),x:t.x,y:t.y,type:this.type(),properties:e}},y.deserialize=function(t){return new y(t,window.svgArea)},y.findObjectBySerialized=function(t){var e,n,r=s.default.layers().find(function(e){return e.name()===t.name});return r&&(e=r._userInputProperties,n=t.properties,Object.keys(e).every(function(t){return e[t]===n[t]})&&Object.keys(e).length==Object.keys(n).length)?r:null},y.prototype.errors=function(){return this._errorProperties||[]},y.prototype.updateStatistics=function(){var t=l.default.EDIT.LAYER.STATISTICS.BAR.MAXWIDTH;return function(e){var n=this._properties[e.name]||\"\",r=function(t){return(t||\"0\").split(\",\").map(function(t){return Number(t)||0}).reduce(function(t,e){return t*e},1)}(n);if(0===r)this._statisticsBar.transition().style(\"opacity\",0),this._statisticsLabel.transition().style(\"opacity\",0);else{var i=e.max||1;this._statisticsLabel.transition().style(\"opacity\",1),this._statisticsLabel.text(n),this._statisticsBar.style(\"opacity\",1),this._statisticsBar.transition().duration(500).attr(\"width\",r/i*t)}this.displayImportantProperty()}}(),y.uniqueSuffixedName=function(t,e){var n=y.splitName(t),r=e.map(function(t){return y.splitName(t.name())}).filter(function(t){return t.name==n.name}).map(function(t){return t.number});if(r.find(function(t){return t===n.number})){r.sort(function(t,e){return t-e}),r.unshift(0);var i=y.findGap(r);return n.name+(1===i?\"\":\"_\"+i)}return t},y.splitName=function(t){var e=function(t){var e=t.lastIndexOf(\"_\");return e>=0?{name:t.substring(0,e),suffix:t.substring(e+1)}:{name:t,suffix:\"\"}}(t),n=Number(e.suffix);return n>0&&n===parseInt(n)&&e.suffix===String(n)?{name:e.name,number:n}:{name:t,number:1}},y.findGap=function(t){for(var e=0,n=t.length;e!=n-1;){var r=parseInt((e+n)/2);t[r]==r?e=r:n=r}return n},y.calcDefaultUniqueName=function(t,e,n){var r=t||e;return y.uniqueSuffixedName(r,n)},y.stripForbiddenCharactersForName=function(t){return t.replace(/[^A-Za-z0-9'_#]/g,\"\").replace(/#/g,\"_\")},y.prototype.calcAndSetUniqueName=function(t){var e=this,n=s.default.layers().filter(function(t){return t!=e}),r=y.stripForbiddenCharactersForName(y.calcDefaultUniqueName(t,this.type(),n));this.name(r)},y.prototype.typedProperties=function(){var t=this;return this._component.property.map(function(e){return Object.assign({},e,{value:t.getProperty(e.name)})})},exports.default=y;"},"hash":"7cf6df1592aa5cc8c58b9f9e59935c21","cacheData":{"env":{}}}